# MediaGo core - Taskfile
# å®‰è£… Task: https://taskfile.dev/installation/
version: "3"

vars:
  APP_NAME: mediago-core
  CMD_PATH: ./cmd/server
  BIN_DIR: ./bin
  RELEASE_DIR: ./release
  TOOLS_BIN_DIR: .bin
  VERSION:
    sh: git describe --tags --always --dirty 2>/dev/null || echo "dev"
  GO_LDFLAGS: -s -w
  # è‡ªåŠ¨æ£€æµ‹å¹³å°å’Œæ¶æ„
  PLATFORM:
    sh: |
      case "{{OS}}" in
        windows) echo "win32" ;;
        darwin) echo "darwin" ;;
        linux) echo "linux" ;;
        *) echo "{{OS}}" ;;
      esac
  ARCH:
    sh: |
      case "{{ARCH}}" in
        amd64) echo "x64" ;;
        arm64) echo "arm64" ;;
        *) echo "{{ARCH}}" ;;
      esac
  # ä¸‹è½½å™¨äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼ˆæ ¹æ®å¹³å°è‡ªåŠ¨è®¾ç½®ï¼‰
  M3U8_BIN_PATH: '{{.TOOLS_BIN_DIR}}/{{.PLATFORM}}/{{.ARCH}}/N_m3u8DL-RE{{if eq OS "windows"}}.exe{{end}}'
  BILIBILI_BIN_PATH: '{{.TOOLS_BIN_DIR}}/{{.PLATFORM}}/{{.ARCH}}/BBDown{{if eq OS "windows"}}.exe{{end}}'
  DIRECT_BIN_PATH: '{{.TOOLS_BIN_DIR}}/{{.PLATFORM}}/{{.ARCH}}/gopeed{{if eq OS "windows"}}.exe{{end}}'

env:
  CGO_ENABLED: 0
  MEDIAGO_SERVER_ADDR: ":8080"
  MEDIAGO_SCHEMA_PATH: "./configs/download_schemas.json"
  # è‡ªåŠ¨è®¾ç½®ä¸‹è½½å™¨äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
  MEDIAGO_M3U8_BIN: '{{.M3U8_BIN_PATH}}'
  MEDIAGO_BILIBILI_BIN: '{{.BILIBILI_BIN_PATH}}'
  MEDIAGO_DIRECT_BIN: '{{.DIRECT_BIN_PATH}}'
  # æ—¥å¿—é…ç½®
  MEDIAGO_LOG_LEVEL: '{{.MEDIAGO_LOG_LEVEL | default "info"}}'
  MEDIAGO_LOG_DIR: '{{.MEDIAGO_LOG_DIR | default "./logs"}}'

tasks:
  default:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - task --list
    silent: true

  # ============================================================
  # å¼€å‘ç¯å¢ƒä»»åŠ¡ (Development Tasks)
  # ============================================================

  dev:
    desc: ã€å¼€å‘ã€‘å¯åŠ¨å¼€å‘æœåŠ¡å™¨
    cmds:
      - go run {{.CMD_PATH}}

  dev:env:
    desc: ã€å¼€å‘ã€‘æ˜¾ç¤ºå½“å‰ç¯å¢ƒå˜é‡é…ç½®
    cmds:
      - echo "========================================="
      - echo "  MediaGo ç¯å¢ƒé…ç½®"
      - echo "========================================="
      - echo "å¹³å° {{OS}}/{{ARCH}} (æ˜ å°„ä¸º {{.PLATFORM}}/{{.ARCH}})"
      - echo ""
      - echo "äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„"
      - echo "  M3U8 ä¸‹è½½å™¨    {{.M3U8_BIN_PATH}}"
      - echo "  Bilibili ä¸‹è½½å™¨ {{.BILIBILI_BIN_PATH}}"
      - echo "  ç›´æ¥ä¸‹è½½å™¨     {{.DIRECT_BIN_PATH}}"
      - echo ""
      - echo "æ–‡ä»¶å­˜åœ¨æ£€æŸ¥"
      - task: _check_file
        vars: { FILE: "{{.M3U8_BIN_PATH}}", NAME: "M3U8 ä¸‹è½½å™¨" }
      - task: _check_file
        vars: { FILE: "{{.BILIBILI_BIN_PATH}}", NAME: "Bilibili ä¸‹è½½å™¨" }
      - task: _check_file
        vars: { FILE: "{{.DIRECT_BIN_PATH}}", NAME: "ç›´æ¥ä¸‹è½½å™¨" }
      - echo ""
      - echo "å…¶ä»–é…ç½®"
      - echo "  æœåŠ¡å™¨åœ°å€ {{.MEDIAGO_SERVER_ADDR}}"
      - echo "  æ—¥å¿—çº§åˆ«   {{.MEDIAGO_LOG_LEVEL | default "info"}}"
      - echo "  æ—¥å¿—ç›®å½•   {{.MEDIAGO_LOG_DIR | default "./logs"}}"
      - echo "========================================="

  dev:watch:
    desc: ã€å¼€å‘ã€‘å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆå¸¦çƒ­é‡è½½ï¼‰
    cmds:
      - |
        {{if eq OS "windows"}}
          echo "Windowsä¸‹è¯·æ‰‹åŠ¨é‡å¯æœåŠ¡"
          go run {{.CMD_PATH}}
        {{else}}
          command -v air >/dev/null 2>&1 || go install github.com/cosmtrek/air@latest
          air
        {{end}}

  dev:build:
    desc: ã€å¼€å‘ã€‘å¿«é€Ÿç¼–è¯‘å½“å‰å¹³å°ï¼ˆç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
    sources:
      - "**/*.go"
      - go.mod
    generates:
      - "{{.BIN_DIR}}/{{.APP_NAME}}*"
    cmds:
      - task: _mkdir
        vars: { DIR: "{{.BIN_DIR}}" }
      - go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}{{exeExt}} {{.CMD_PATH}}
      - echo "âœ… å¼€å‘ç‰ˆæœ¬ç¼–è¯‘æˆåŠŸ -> {{.BIN_DIR}}/{{.APP_NAME}}{{exeExt}}"

  dev:test:
    desc: ã€å¼€å‘ã€‘è¿è¡Œæ‰€æœ‰æµ‹è¯•
    cmds:
      - go test -v ./...

  dev:test:unit:
    desc: ã€å¼€å‘ã€‘è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¿«é€Ÿï¼‰
    cmds:
      - go test -short -v ./...

  dev:test:coverage:
    desc: ã€å¼€å‘ã€‘ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - go test -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "âœ… è¦†ç›–ç‡æŠ¥å‘Š coverage.html"

  dev:fmt:
    desc: ã€å¼€å‘ã€‘æ ¼å¼åŒ–ä»£ç 
    cmds:
      - go fmt ./...
      - echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

  dev:lint:
    desc: ã€å¼€å‘ã€‘ä»£ç é™æ€æ£€æŸ¥
    cmds:
      - |
        {{if eq OS "windows"}}
          where golangci-lint >nul 2>&1 || go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        {{else}}
          command -v golangci-lint >/dev/null 2>&1 || go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        {{end}}
        golangci-lint run ./...

  dev:tidy:
    desc: ã€å¼€å‘ã€‘æ•´ç†å¹¶æ¸…ç† Go æ¨¡å—ä¾èµ–
    cmds:
      - go mod tidy
      - echo "âœ… ä¾èµ–æ•´ç†å®Œæˆ"

  dev:swagger:
    desc: ã€å¼€å‘ã€‘ç”Ÿæˆ Swagger API æ–‡æ¡£
    sources:
      - "cmd/**/*.go"
      - "internal/**/*.go"
    generates:
      - "docs/swagger.json"
    cmds:
      - |
        {{if eq OS "windows"}}
          where swag >nul 2>&1 || go install github.com/swaggo/swag/cmd/swag@latest
        {{else}}
          command -v swag >/dev/null 2>&1 || go install github.com/swaggo/swag/cmd/swag@latest
        {{end}}
        swag init -g cmd/server/main.go -o docs --parseDependency --parseInternal
        echo "âœ… Swagger æ–‡æ¡£ç”Ÿæˆå®Œæˆ"

  dev:swagger:open:
    desc: ã€å¼€å‘ã€‘æ‰“å¼€ Swagger UI
    cmds:
      - echo "ğŸ“– Swagger UI http://localhost:8080/swagger/index.html"
      - |
        {{if eq OS "windows"}}start http://localhost:8080/swagger/index.html
        {{else if eq OS "darwin"}}open http://localhost:8080/swagger/index.html
        {{else}}xdg-open http://localhost:8080/swagger/index.html{{end}}

  dev:docker:
    desc: ã€å¼€å‘ã€‘æ„å»ºå¹¶è¿è¡Œ Docker å®¹å™¨
    cmds:
      - docker build -t {{.APP_NAME}}:{{.VERSION}} .
      - docker run -it --rm -p 8080:8080 {{.APP_NAME}}:{{.VERSION}}

  dev:tools:
    desc: ã€å¼€å‘ã€‘å®‰è£…æ‰€æœ‰å¼€å‘å·¥å…·
    cmds:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install github.com/swaggo/swag/cmd/swag@latest
      - go install github.com/cosmtrek/air@latest
      - echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

  dev:clean:
    desc: ã€å¼€å‘ã€‘æ¸…ç†å¼€å‘ç¯å¢ƒäº§ç‰©
    cmds:
      - task: _rmrf
        vars: { PATH: "{{.BIN_DIR}}" }
      - task: _rmrf
        vars: { PATH: "coverage.out" }
      - task: _rmrf
        vars: { PATH: "coverage.html" }
      - task: _rmrf
        vars: { PATH: "docs/swagger.json" }
      - task: _rmrf
        vars: { PATH: "docs/swagger.yaml" }
      - echo "âœ… å¼€å‘ç¯å¢ƒæ¸…ç†å®Œæˆ"

  dev:check:
    desc: ã€å¼€å‘ã€‘ä»£ç è´¨é‡å…¨é¢æ£€æŸ¥ï¼ˆæ ¼å¼åŒ– + æµ‹è¯• + é™æ€æ£€æŸ¥ï¼‰
    cmds:
      - task: dev:fmt
      - task: dev:lint
      - task: dev:test:unit
      - echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡"

  # ============================================================
  # å‘å¸ƒç¯å¢ƒä»»åŠ¡ (Release/Production Tasks)
  # ============================================================

  release:build:
    desc: ã€å‘å¸ƒã€‘æ„å»ºæ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä»…ç¼–è¯‘ï¼Œä¸æ‰“åŒ…å·¥å…·ï¼‰
    cmds:
      - task: _mkdir
        vars: { DIR: "{{.BIN_DIR}}" }
      - task: release:build:binary
        vars: { GOOS: linux, GOARCH: amd64 }
      - task: release:build:binary
        vars: { GOOS: linux, GOARCH: arm64 }
      - task: release:build:binary
        vars: { GOOS: darwin, GOARCH: amd64 }
      - task: release:build:binary
        vars: { GOOS: darwin, GOARCH: arm64 }
      - task: release:build:binary
        vars: { GOOS: windows, GOARCH: amd64 }
      - task: release:build:binary
        vars: { GOOS: windows, GOARCH: arm64 }
      - echo "âœ… å…¨å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¯‘å®Œæˆ"

  release:build:binary:
    internal: true
    vars:
      EXT: '{{if eq .GOOS "windows"}}.exe{{end}}'
      OUTPUT: '{{.BIN_DIR}}/{{.APP_NAME}}-{{.GOOS}}-{{.GOARCH}}{{.EXT}}'
    cmds:
      - CGO_ENABLED=0 GOOS={{.GOOS}} GOARCH={{.GOARCH}} go build -ldflags="{{.GO_LDFLAGS}}" -o {{.OUTPUT}} {{.CMD_PATH}}
      - echo "âœ“ {{.GOOS}}/{{.GOARCH}}"

  release:package:
    desc: ã€å‘å¸ƒã€‘æ‰“åŒ…æ‰€æœ‰å¹³å°çš„å®Œæ•´å‘å¸ƒåŒ…ï¼ˆåŒ…å«ä¸‹è½½å™¨å·¥å…·ï¼‰
    cmds:
      - task: release:clean
      - task: release:build
      - echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…å„å¹³å°å‘å¸ƒåŒ…..."
      - task: release:package:platform
        vars: { GOOS: linux, GOARCH: amd64, PLATFORM: linux, ARCH: x64 }
      - task: release:package:platform
        vars: { GOOS: linux, GOARCH: arm64, PLATFORM: linux, ARCH: arm64 }
      - task: release:package:platform
        vars: { GOOS: darwin, GOARCH: amd64, PLATFORM: darwin, ARCH: x64 }
      - task: release:package:platform
        vars: { GOOS: darwin, GOARCH: arm64, PLATFORM: darwin, ARCH: arm64 }
      - task: release:package:platform
        vars: { GOOS: windows, GOARCH: amd64, PLATFORM: win32, ARCH: x64 }
      - task: release:package:platform
        vars: { GOOS: windows, GOARCH: arm64, PLATFORM: win32, ARCH: arm64 }
      - echo "âœ… æ‰€æœ‰å¹³å°å‘å¸ƒåŒ…æ‰“åŒ…å®Œæˆ"
      - echo "ğŸ“¦ å‘å¸ƒåŒ…ä½ç½® {{.RELEASE_DIR}}/packages/"
      - task: release:package:list

  release:package:platform:
    internal: true
    vars:
      EXT: '{{if eq .GOOS "windows"}}.exe{{end}}'
      PKG_NAME: '{{.APP_NAME}}-{{.GOOS}}-{{.GOARCH}}'
      PKG_DIR: '{{.RELEASE_DIR}}/packages/{{.PKG_NAME}}'
      TOOLS_SRC: '{{.TOOLS_BIN_DIR}}/{{.PLATFORM}}/{{.ARCH}}'
    cmds:
      # åˆ›å»ºå‘å¸ƒåŒ…ç›®å½•ç»“æ„
      - task: _mkdir
        vars: { DIR: "{{.PKG_DIR}}" }
      - task: _mkdir
        vars: { DIR: "{{.PKG_DIR}}/bin" }
      - task: _mkdir
        vars: { DIR: "{{.PKG_DIR}}/configs" }
      - task: _mkdir
        vars: { DIR: "{{.PKG_DIR}}/logs" }

      # å¤åˆ¶ä¸»ç¨‹åº
      - task: _cp
        vars:
          SRC: "{{.BIN_DIR}}/{{.PKG_NAME}}{{.EXT}}"
          DST: "{{.PKG_DIR}}/{{.APP_NAME}}{{.EXT}}"

      # å¤åˆ¶ä¸‹è½½å™¨å·¥å…·
      - task: _cp_dir
        vars:
          SRC: "{{.TOOLS_SRC}}"
          DST: "{{.PKG_DIR}}/bin"

      # å¤åˆ¶é…ç½®æ–‡ä»¶
      - task: _cp
        vars:
          SRC: "configs/download_schemas.json"
          DST: "{{.PKG_DIR}}/configs/"

      # åˆ›å»ºå¯åŠ¨è„šæœ¬å’Œè¯´æ˜æ–‡ä»¶
      - task: release:package:create_readme
        vars:
          PKG_DIR: "{{.PKG_DIR}}"
          GOOS: "{{.GOOS}}"
          EXT: "{{.EXT}}"

      # è®¾ç½®å¯æ‰§è¡Œæƒé™ï¼ˆé Windowsï¼‰
      - task: release:package:set_permissions
        vars:
          PKG_DIR: "{{.PKG_DIR}}"
          GOOS: "{{.GOOS}}"

      - echo "âœ“ {{.GOOS}}/{{.GOARCH}} å‘å¸ƒåŒ…å·²æ‰“åŒ…"

  release:package:create_readme:
    internal: true
    silent: true
    cmds:
      - |
        cat > "{{.PKG_DIR}}/README.txt" << 'EOF'
        MediaGo core - å‘å¸ƒåŒ…è¯´æ˜
        =====================================

        ç›®å½•ç»“æ„:
          mediago-core{{.EXT}}   - ä¸»ç¨‹åº
          bin/                          - ä¸‹è½½å™¨å·¥å…·ç›®å½•
            â”œâ”€â”€ N_m3u8DL-RE{{.EXT}}     - M3U8 ä¸‹è½½å™¨
            â”œâ”€â”€ BBDown{{.EXT}}          - Bilibili ä¸‹è½½å™¨
            â”œâ”€â”€ gopeed{{.EXT}}          - ç›´æ¥ä¸‹è½½å™¨
            â””â”€â”€ ffmpeg{{.EXT}}          - FFmpeg (å¦‚æœå­˜åœ¨)
          configs/                      - é…ç½®æ–‡ä»¶ç›®å½•
            â””â”€â”€ download_schemas.json   - ä¸‹è½½é…ç½®
          logs/                         - æ—¥å¿—ç›®å½•

        ä½¿ç”¨æ–¹æ³•:
          {{if eq .GOOS "windows"}}
          1. åŒå‡»è¿è¡Œ mediago-core.exe
          2. æˆ–åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ: mediago-core.exe
          {{else}}
          1. åœ¨ç»ˆç«¯ä¸­è¿è¡Œ: ./mediago-core
          2. æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬: ./start.sh
          {{end}}

        ç¯å¢ƒå˜é‡é…ç½®:
          ç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨ bin/ ç›®å½•ä¸‹çš„ä¸‹è½½å™¨å·¥å…·ã€‚
          å¦‚éœ€è‡ªå®šä¹‰é…ç½®ï¼Œå¯è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡:
            - MEDIAGO_M3U8_BIN       M3U8 ä¸‹è½½å™¨è·¯å¾„
            - MEDIAGO_BILIBILI_BIN   Bilibili ä¸‹è½½å™¨è·¯å¾„
            - MEDIAGO_DIRECT_BIN     ç›´æ¥ä¸‹è½½å™¨è·¯å¾„
            - MEDIAGO_LOG_LEVEL      æ—¥å¿—çº§åˆ« (debug/info/warn/error)
            - MEDIAGO_LOG_DIR        æ—¥å¿—ç›®å½•è·¯å¾„
            - MEDIAGO_SERVER_ADDR    æœåŠ¡å™¨ç›‘å¬åœ°å€ (é»˜è®¤ :8080)

        æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/caorushizi/mediago
        EOF
      - |
        {{if ne .GOOS "windows"}}
        cat > "{{.PKG_DIR}}/start.sh" << 'EOF'
        #!/bin/bash
        # MediaGo core å¯åŠ¨è„šæœ¬

        # è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export MEDIAGO_M3U8_BIN="$DIR/bin/N_m3u8DL-RE"
        export MEDIAGO_BILIBILI_BIN="$DIR/bin/BBDown"
        export MEDIAGO_DIRECT_BIN="$DIR/bin/gopeed"
        export MEDIAGO_SCHEMA_PATH="$DIR/configs/download_schemas.json"
        export MEDIAGO_LOG_DIR="$DIR/logs"

        # å¯åŠ¨ç¨‹åº
        echo "æ­£åœ¨å¯åŠ¨ MediaGo core..."
        ./mediago-core
        EOF
        chmod +x "{{.PKG_DIR}}/start.sh"
        {{end}}

  release:package:set_permissions:
    internal: true
    silent: true
    cmds:
      - |
        {{if ne .GOOS "windows"}}
        chmod +x "{{.PKG_DIR}}/mediago-core"
        chmod +x "{{.PKG_DIR}}/bin/"* 2>/dev/null || true
        {{end}}

  release:package:list:
    internal: true
    silent: true
    cmds:
      - |
        echo ""
        echo "å‘å¸ƒåŒ…åˆ—è¡¨:"
        {{if eq OS "windows"}}
        dir /B "{{.RELEASE_DIR}}\packages" 2>nul || echo "æ— å‘å¸ƒåŒ…"
        {{else}}
        ls -1 "{{.RELEASE_DIR}}/packages" 2>/dev/null || echo "æ— å‘å¸ƒåŒ…"
        {{end}}
        echo ""
        echo "æ‰“åŒ…å®Œæˆçš„æ–‡ä»¶ä½äº {{.RELEASE_DIR}}/packages/"

  release:package:zip:
    desc: ã€å‘å¸ƒã€‘å°†å‘å¸ƒåŒ…å‹ç¼©ä¸º zip æ–‡ä»¶
    cmds:
      - echo "ğŸ—œï¸  æ­£åœ¨å‹ç¼©å‘å¸ƒåŒ…..."
      - task: release:package:zip:platform
        vars: { GOOS: linux, GOARCH: amd64 }
      - task: release:package:zip:platform
        vars: { GOOS: linux, GOARCH: arm64 }
      - task: release:package:zip:platform
        vars: { GOOS: darwin, GOARCH: amd64 }
      - task: release:package:zip:platform
        vars: { GOOS: darwin, GOARCH: arm64 }
      - task: release:package:zip:platform
        vars: { GOOS: windows, GOARCH: amd64 }
      - task: release:package:zip:platform
        vars: { GOOS: windows, GOARCH: arm64 }
      - echo "âœ… æ‰€æœ‰å‘å¸ƒåŒ…å·²å‹ç¼©"
      - echo "ğŸ“¦ å‹ç¼©åŒ…ä½ç½®åœ¨ {{.RELEASE_DIR}}/archives/"

  release:package:zip:platform:
    internal: true
    vars:
      PKG_NAME: '{{.APP_NAME}}-{{.GOOS}}-{{.GOARCH}}'
      PKG_DIR: '{{.RELEASE_DIR}}/packages/{{.PKG_NAME}}'
      ARCHIVE_DIR: '{{.RELEASE_DIR}}/archives'
    cmds:
      - task: _mkdir
        vars: { DIR: "{{.ARCHIVE_DIR}}" }
      - |
        cd "{{.RELEASE_DIR}}/packages" && \
        {{if eq OS "windows"}}
        powershell -Command "Compress-Archive -Path '{{.PKG_NAME}}' -DestinationPath '../archives/{{.PKG_NAME}}.zip' -Force"
        {{else}}
        zip -r "../archives/{{.PKG_NAME}}.zip" "{{.PKG_NAME}}"
        {{end}}
      - echo "âœ“ {{.PKG_NAME}}.zip"

  release:test:
    desc: ã€å‘å¸ƒã€‘è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    cmds:
      - go test -race -timeout 10m ./...
      - echo "âœ… å®Œæ•´æµ‹è¯•é€šè¿‡"

  release:clean:
    desc: ã€å‘å¸ƒã€‘æ¸…ç†æ‰€æœ‰å‘å¸ƒäº§ç‰©
    cmds:
      - task: _rmrf
        vars: { PATH: "{{.BIN_DIR}}" }
      - task: _rmrf
        vars: { PATH: "{{.RELEASE_DIR}}" }
      - echo "âœ… å‘å¸ƒäº§ç‰©æ¸…ç†å®Œæˆ"

  release:prepare:
    desc: ã€å‘å¸ƒã€‘å®Œæ•´å‘å¸ƒæµç¨‹ï¼ˆæµ‹è¯• + æ„å»º + æ‰“åŒ… + å‹ç¼©ï¼‰
    cmds:
      - task: release:clean
      - task: dev:tidy
      - task: release:test
      - task: release:package
      - task: release:package:zip
      - echo "âœ… å®Œæ•´å‘å¸ƒæµç¨‹å®Œæˆ"
      - echo "ğŸ“¦ å‘å¸ƒåŒ…ä½ç½® {{.RELEASE_DIR}}/packages/"
      - echo "ğŸ—œï¸  å‹ç¼©åŒ…ä½ç½® {{.RELEASE_DIR}}/archives/"

  # ============================================================
  # NPM å‘å¸ƒä»»åŠ¡ (NPM Release Pipeline)
  # ============================================================

  release:npm:clean:
    desc: ã€NPMã€‘æ¸…ç† NPM å‘å¸ƒäº§ç‰©
    cmds:
      - task: _rmrf
        vars: { PATH: "{{.RELEASE_DIR}}/npm" }
      - task: _clean_npm_bins
      - echo "âœ… NPM å‘å¸ƒäº§ç‰©æ¸…ç†å®Œæˆ"

  release:npm:build:
    desc: ã€NPMã€‘æ„å»ºæ‰€æœ‰å¹³å°çš„ NPM åŒ…äºŒè¿›åˆ¶æ–‡ä»¶
    cmds:
      - task: release:npm:build:binary
        vars: { GOOS: darwin, GOARCH: amd64, PLATFORM: darwin-x64 }
      - task: release:npm:build:binary
        vars: { GOOS: darwin, GOARCH: arm64, PLATFORM: darwin-arm64 }
      - task: release:npm:build:binary
        vars: { GOOS: linux, GOARCH: amd64, PLATFORM: linux-x64 }
      - task: release:npm:build:binary
        vars: { GOOS: linux, GOARCH: arm64, PLATFORM: linux-arm64 }
      - task: release:npm:build:binary
        vars: { GOOS: windows, GOARCH: amd64, PLATFORM: win32-x64 }
      - task: release:npm:build:binary
        vars: { GOOS: windows, GOARCH: arm64, PLATFORM: win32-arm64 }
      - echo "âœ… NPM æ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºå®Œæˆ"

  release:npm:build:binary:
    internal: true
    vars:
      EXT: '{{if eq .GOOS "windows"}}.exe{{end}}'
      OUTPUT_DIR: '{{.RELEASE_DIR}}/npm/{{.PLATFORM}}/bin'
    cmds:
      - task: _mkdir
        vars: { DIR: "{{.OUTPUT_DIR}}" }
      - CGO_ENABLED=0 GOOS={{.GOOS}} GOARCH={{.GOARCH}} go build -ldflags="{{.GO_LDFLAGS}}" -o {{.OUTPUT_DIR}}/mediago-core{{.EXT}} {{.CMD_PATH}}
      - echo "âœ“ NPM {{.PLATFORM}}"

  release:npm:assemble:
    desc: ã€NPMã€‘ç»„è£… NPM åŒ…ï¼ˆç”Ÿæˆ package.json å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
    deps: [release:package]
    cmds:
      - node scripts/generate-npm-packages.js {{.VERSION}}
      - task: release:npm:copy
      - task: release:npm:permissions
      - echo "âœ… NPM åŒ…ç»„è£…å®Œæˆ (ç‰ˆæœ¬{{.VERSION}})"

  release:npm:copy:
    internal: true
    cmds:
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-darwin-x64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-darwin-amd64/*", DST: "npm/@mediago/core-darwin-x64/files/" }
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-darwin-arm64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-darwin-arm64/*", DST: "npm/@mediago/core-darwin-arm64/files/" }
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-linux-x64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-linux-amd64/*", DST: "npm/@mediago/core-linux-x64/files/" }
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-linux-arm64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-linux-arm64/*", DST: "npm/@mediago/core-linux-arm64/files/" }
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-win32-x64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-windows-amd64/*", DST: "npm/@mediago/core-win32-x64/files/" }
      - task: _mkdir
        vars: { DIR: "npm/@mediago/core-win32-arm64/files" }
      - task: _cp
        vars: { SRC: "{{.RELEASE_DIR}}/packages/mediago-core-windows-arm64/*", DST: "npm/@mediago/core-win32-arm64/files/" }

  release:npm:permissions:
    internal: true
    cmds:
      - |
        {{if ne OS "windows"}}
          chmod -R +x npm/@mediago/core-darwin-x64/files
          chmod -R +x npm/@mediago/core-darwin-arm64/files
          chmod -R +x npm/@mediago/core-linux-x64/files
          chmod -R +x npm/@mediago/core-linux-arm64/files
        {{end}}

  release:npm:verify:
    internal: true
    preconditions:
      - sh: '[ "{{.PUBLISH}}" = "true" ]'
        msg: "âš ï¸  å¿…é¡»è®¾ç½® PUBLISH=true æ‰èƒ½å‘å¸ƒåˆ° NPM"
      - sh: '[ -n "{{.VERSION}}" ]'
        msg: "âš ï¸  å¿…é¡»è®¾ç½® VERSION (ä¾‹å¦‚: VERSION=1.2.3)"

  release:npm:publish:
    desc: ã€NPMã€‘å‘å¸ƒ NPM åŒ…åˆ° NPM Registryï¼ˆéœ€è¦ PUBLISH=trueï¼‰
    cmds:
      - task: release:npm:verify
      - cd npm/@mediago/core-darwin-x64 && npm publish --access public
      - cd npm/@mediago/core-darwin-arm64 && npm publish --access public
      - cd npm/@mediago/core-linux-x64 && npm publish --access public
      - cd npm/@mediago/core-linux-arm64 && npm publish --access public
      - cd npm/@mediago/core-win32-x64 && npm publish --access public
      - cd npm/@mediago/core-win32-arm64 && npm publish --access public
      - cd npm/@mediago/core && npm publish --access public
      - echo "âœ… NPM åŒ…å‘å¸ƒæˆåŠŸ (ç‰ˆæœ¬{{.VERSION}})"

  release:npm:
    desc: ã€NPMã€‘å®Œæ•´ NPM å‘å¸ƒæµç¨‹ï¼ˆè®¾ç½® VERSION=x.y.z å’Œå¯é€‰çš„ PUBLISH=trueï¼‰
    cmds:
      - task: release:npm:clean
      - task: release:npm:assemble
        vars: { VERSION: '{{.VERSION | default "0.0.0"}}' }
      - |
        {{if eq .PUBLISH "true"}}
          task release:npm:publish VERSION={{.VERSION}} PUBLISH={{.PUBLISH}}
        {{else}}
          echo "ğŸ” è¯•è¿è¡Œå®Œæˆã€‚è®¾ç½® PUBLISH=true ä»¥å‘å¸ƒåˆ° NPMã€‚"
          echo "ğŸ“¦ NPM åŒ…å·²å‡†å¤‡å°±ç»ªåœ¨ npm/@mediago/"
        {{end}}

  release:npm:dry-run:
    desc: ã€NPMã€‘NPM å‘å¸ƒæ¼”ç»ƒï¼ˆä¸å®é™…å‘å¸ƒï¼‰
    cmds:
      - task: release:npm
        vars: { VERSION: '{{.VERSION | default "0.0.0"}}', PUBLISH: "false" }

  # ============================================================
  # å¿«æ·å‘½ä»¤ (Shortcuts)
  # ============================================================

  run:
    desc: è¿è¡ŒæœåŠ¡ï¼ˆdev çš„åˆ«åï¼‰
    cmds:
      - task: dev

  build:
    desc: æ„å»ºå½“å‰å¹³å°ï¼ˆdev:build çš„åˆ«åï¼‰
    cmds:
      - task: dev:build

  test:
    desc: è¿è¡Œæµ‹è¯•ï¼ˆdev:test çš„åˆ«åï¼‰
    cmds:
      - task: dev:test

  clean:
    desc: æ¸…ç†æ‰€æœ‰äº§ç‰©
    cmds:
      - task: dev:clean
      - task: release:clean
      - task: release:npm:clean

  # ============================================================
  # å†…éƒ¨è¾…åŠ©ä»»åŠ¡ (Internal Helpers)
  # ============================================================

  _mkdir:
    internal: true
    platforms: [linux, darwin, windows]
    cmds:
      - mkdir -p {{.DIR}}

  _rmrf:
    internal: true
    platforms: [linux, darwin, windows]
    cmds:
      - defer: { task: _ignore_error }
      - rm -rf {{.PATH}}

  _cp:
    internal: true
    platforms: [linux, darwin, windows]
    cmds:
      - cp -r {{.SRC}} {{.DST}}

  _cp_dir:
    internal: true
    platforms: [linux, darwin, windows]
    cmds:
      - cp -r {{.SRC}}/* {{.DST}}/

  _check_file:
    internal: true
    platforms: [linux, darwin, windows]
    silent: true
    cmds:
      - |
        if [ -f "{{.FILE}}" ]; then
          echo "  âœ“ {{.NAME}} å­˜åœ¨"
        else
          echo "  âœ— {{.NAME}} ä¸å­˜åœ¨"
        fi

  _clean_npm_bins:
    internal: true
    platforms: [linux, darwin, windows]
    cmds:
      - |
        for dir in npm/@mediago/*/bin; do
          if [ -d "$dir" ]; then
            rm -rf "$dir"
          fi
        done || true

  _ignore_error:
    internal: true
    cmds:
      - exit 0
