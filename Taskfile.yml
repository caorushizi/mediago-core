# MediaGo Downloader - Taskfile (ç®€åŒ–ç‰ˆ)
# å®‰è£… Task: https://taskfile.dev/installation/
version: '3'

vars:
  APP_NAME: mediago-downloader
  CMD_PATH: ./cmd/downloader
  BIN_DIR: ./bin
  VERSION:
    sh: git describe --tags --always --dirty 2>/dev/null || echo "dev"
  GO_LDFLAGS: -s -w

env:
  CGO_ENABLED: 0
  MEDIAGO_SERVER_ADDR: ":8080"
  MEDIAGO_SCHEMA_PATH: "./configs/download_schemas.json"

tasks:
  default:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - task --list
    silent: true

  # ==================== å¼€å‘ä»»åŠ¡ ====================

  run:
    desc: è¿è¡ŒæœåŠ¡
    cmds:
      - go run {{.CMD_PATH}}

  # ==================== æ„å»ºä»»åŠ¡ ====================

  build:
    desc: ç¼–è¯‘å½“å‰å¹³å°
    sources:
      - "**/*.go"
      - go.mod
    generates:
      - "{{.BIN_DIR}}/{{.APP_NAME}}*"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}{{exeExt}} {{.CMD_PATH}}
      - echo "âœ… ç¼–è¯‘æˆåŠŸ"

  build:all:
    desc: äº¤å‰ç¼–è¯‘æ‰€æœ‰å¹³å°
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - GOOS=linux GOARCH=amd64 go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}-linux-amd64 {{.CMD_PATH}}
      - GOOS=darwin GOARCH=amd64 go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}-darwin-amd64 {{.CMD_PATH}}
      - GOOS=darwin GOARCH=arm64 go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}-darwin-arm64 {{.CMD_PATH}}
      - GOOS=windows GOARCH=amd64 go build -ldflags "{{.GO_LDFLAGS}}" -o {{.BIN_DIR}}/{{.APP_NAME}}-windows-amd64.exe {{.CMD_PATH}}
      - echo "âœ… å…¨å¹³å°ç¼–è¯‘å®Œæˆ"

  # ==================== æµ‹è¯•ä»»åŠ¡ ====================

  test:
    desc: è¿è¡Œæµ‹è¯•
    cmds:
      - go test -v ./...

  test:coverage:
    desc: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - go test -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"

  # ==================== ä»£ç è´¨é‡ ====================

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - go fmt ./...

  lint:
    desc: ä»£ç æ£€æŸ¥
    cmds:
      - golangci-lint run ./...

  tidy:
    desc: æ•´ç†ä¾èµ–
    cmds:
      - go mod tidy

  # ==================== æ¸…ç†ä»»åŠ¡ ====================

  clean:
    desc: æ¸…ç†æ„å»ºäº§ç‰©
    cmds:
      - rm -rf {{.BIN_DIR}} coverage.* docs/

  # ==================== Swagger æ–‡æ¡£ ====================

  swagger:
    desc: ç”Ÿæˆ Swagger æ–‡æ¡£
    sources:
      - "cmd/**/*.go"
      - "internal/**/*.go"
    generates:
      - "docs/swagger.json"
    cmds:
      - swag init -g cmd/downloader/main.go -o docs --parseDependency --parseInternal
      - echo "âœ… Swagger æ–‡æ¡£ç”Ÿæˆå®Œæˆ"

  swagger:open:
    desc: æ‰“å¼€ Swagger UI
    cmds:
      - echo "ğŸ“– http://localhost:8080/swagger/index.html"
      - |
        {{if eq OS "windows"}}start http://localhost:8080/swagger/index.html
        {{else if eq OS "darwin"}}open http://localhost:8080/swagger/index.html
        {{else}}xdg-open http://localhost:8080/swagger/index.html{{end}}

  # ==================== Docker ä»»åŠ¡ ====================

  docker:
    desc: æ„å»ºå¹¶è¿è¡Œ Docker
    cmds:
      - docker build -t {{.APP_NAME}}:{{.VERSION}} .
      - docker run -it --rm -p 8080:8080 {{.APP_NAME}}:{{.VERSION}}

  # ==================== å‘å¸ƒä»»åŠ¡ ====================

  release:
    desc: æ„å»ºå‘å¸ƒç‰ˆæœ¬
    cmds:
      - task: clean
      - task: test
      - task: build:all
      - echo "âœ… å‘å¸ƒå®Œæˆ"

  # ==================== è¾…åŠ©ä»»åŠ¡ ====================

  tools:
    desc: å®‰è£…å¼€å‘å·¥å…·
    cmds:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install github.com/swaggo/swag/cmd/swag@latest
      - echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
